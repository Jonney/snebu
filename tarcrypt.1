.TH TARCRYPT "1" "December 2020" "tarcrypt" "User Commands"
.na
.SH NAME
tarcrypt \- Compresses and encrypts file data in TAR files
.SH SYNOPSIS
.B tarcrypt
\fBencrypt\fR \fB-k\fR \fIkeyfile\fR
.sp
.B tarcrypt
\fBdecrypt\fR
.sp
.B tarcrypt
\fBgenkey\fR \fB-f\fR \fIkeyfile\fR
\fB-c\fR \fIcomment\fR
.SH DESCRIPTION
The \fItarcrypt\fR command acts as a filter for the \fItar\fR command.
In encryption mode, it will compress and encrypt the data portion of TAR files
while leaving header metadata intact.  This allows the TAR file to be sent to
a backup system that expects the Unix TAR format as input.
.PP
The key file that is generated by the \fIgenkey\fR function contains an encrypted
(passphrase protected) RSA private key, public key, and HMAC key used for verification.
The encrypted private key, public key, and a hash of the HMAC key are stored in
the TAR file's global header.
.PP
Each individual file is encrypted with a random AES-256 key, which is in turn encrypted
using the RSA public key.  The file contents is also signed using the HMAC key,
and the signature for the file is attached to the file header.
.PP
During a decrypt operation, the user is prompted for the passphrase protecting the private key,
which is used to decrypt the AES key stored with each file.
The passphrase, along with the public key hash, are used to re-create the secret HMAC key
in order to validate each file contents as it is begin decrypted.
.SH OPTIONS
.TP
\fBencrypt\fR
Reads the tar command output on standard input, outputting an encrypted tar file.
.RS
\fBParameters\fR:
.TP
\fB-k\fR, \fB\-\-keyfile\fR \fIkeyfilename\fR
Specifies the key file (generated by the \fIgenkey\fR subcommand)
.sp
Multiple key files may be specified by repeating this parameter.
.RE
.TP
\fBdecrypt\fR
Reads an encrypted tar file on standard input, prompts for the passphrase,
decrypts and verifies contents outputting a standard tar file.
.TP
\fBgenkey\fR
Generates a key file used by the \fIencrypt\fR function.
.RS
\fBParameters:\fR
.TP
\fB-f\fR, \fB\-\-filename\fR \fIkeyfilename\fR
Specifies the filename to write the keyfile out to.
.TP
[ \fB-c\fR, \fB\-\-comment\fR "\fIcomment text\fR" ]
Specifies a comment to include in the keyfile.
.PP
.SH SECURITY
Public Key cryptography splits up a key into two parts -- an encryption (public) key, and a decryption (private) key.
The public key isn't considered sensitive -- it is designed so that one party can send encrypted data to another party,
by using the other party's public key.  The private key, however, needs to be kept confidential by the receiving party.
Typically the private key is stored encrypted with a symmetric algorithm (one where the same password is used to both encrypt
and decrypt the data) to provide additional security.
.PP
In the case of tarcrypt, the sending and receiving party is the same entity,
using a third party (the backup server) to store the encrypted data.
If the backup is needed, chances are that the keyfile used to encrypt the backup is lost also.
Therefore, both the public key (for reference), and an encrypted copy of the private key are stored
in the generated encrypted tar file's global header.
.PP
For the purpose of file confidentiality the keyfile isn't considered sensitive,
as the private key used to decrypt the data is stored in encrypted form.
However, the keyfile also contains a secret HMAC key used to authenticate the contents of the encrypted
tar file.  Therefore if authenticity is needed, then the keyfile must be kept confidential
(i.e., stored with appropriate file system permissions to be accessed only by the backup process).
.SH NOTES
The tarcrypt file format is an extension of the PAX TAR format, with custom values in the PAX header.
If used in conjunction with a backup tool which expects the TAR format as input,
then the backup tool may need some modifications in order to handle the extensions.
If the tool stores the tar file intact, and if it doesn't choke on the custom header fields,
then no modifications should be necessary.  However if the backup system parses out the TAR file format
(i.e., it if uses it as a serialization format), then it would need to be modified to store the encrypted
header info along with the rest of the metadata, and re-generate the appropriate global and individual
file headers.
.PP
